<!-- ========== Template Extension ========== -->
<!-- This template extends the base.html layout to inherit navigation, footer, and common structure -->
{% extends "base.html" %}

<!-- ========== Page Title Block ========== -->
<!-- Set the browser tab title to show which file's concept map is being viewed -->
{% block title %}Concept Map - {{ material.filename }}{% endblock %}

<!-- ========== Main Content Block ========== -->
<!-- This is where the interactive D3.js concept map visualization will appear -->
{% block content %}
<div class="container concept-map-container">
    <!-- ========== Page Header Section ========== -->
    <!-- Shows the page title, filename, and navigation back to dashboard -->
    <div class="concept-map-header">
        <h1><i class="fas fa-project-diagram"></i> Concept Map</h1>
        <p class="subtitle">{{ material.filename }}</p>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <!-- ========== Concept Map Visualization Section ========== -->
    <!-- Two-column layout: graph on left, topics list on right -->
    <div class="concept-visualization">
        <!-- ========== Graph Container ========== -->
        <!-- This div will hold the D3.js SVG graph -->
        <div id="graph-container">
            <!-- Loading message shown until graph is ready -->
            <div id="loading-message">Initializing concept map...</div>
        </div>
        
        <!-- ========== Topics Sidebar ========== -->
        <!-- Shows a list of all topics covered in the material -->
        <div class="topics-list">
            <h3>Topics Covered:</h3>
            <ul>
                <!-- Loop through topics from database -->
                {% if topics %}
                    {% for topic in topics %}
                    <li><i class="fas fa-tag"></i> {{ topic.topic_name }}</li>
                    {% endfor %}
                {% else %}
                    <!-- Fallback if no topics found -->
                    <li><i class="fas fa-tag"></i> Main Concepts</li>
                {% endif %}
            </ul>
        </div>
    </div>

    <!-- ========== D3.js Library ========== -->
    <!-- Load D3.js from CDN for graph visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- ========== Concept Map JavaScript ========== -->
    <!-- Script to create and render the interactive D3.js graph -->
    <script>
        /**
         * Interactive Concept Map Visualization
         * 
         * This script creates a force-directed graph showing relationships between topics:
         * - Loads graph data from Flask backend
         * - Creates fallback graph if no data available
         * - Renders interactive D3.js visualization
         * - Enables drag-and-drop node positioning
         * - Shows topic connections with lines
         */
        
        console.log(' Starting concept map initialization...');
        
        // ========== Load Graph Data from Backend ==========
        // Get the graph data passed from Flask template
        let graphData;
        try {
            // Parse JSON data from Flask (contains nodes and edges)
            graphData = {{ concept_graph.graph | tojson | safe }};
            console.log(' Graph Data:', graphData);
        } catch (e) {
            // If parsing fails, log error and set to null
            console.error(' Error parsing graph data:', e);
            graphData = null;
        }
        
        // ========== Create Fallback Graph if Needed ==========
        // If no graph data from backend, create a default graph structure
        if (!graphData || !graphData.nodes || graphData.nodes.length === 0) {
            console.warn(' Creating fallback graph...');
            
            // Get topics from template or use defaults
            const fallbackTopics = [
                {% if topics %}
                    // Use actual topics from database (limited to first 8)
                    {% for topic in topics[:8] %}
                    "{{ topic.topic_name | safe }}",
                    {% endfor %}
                {% else %}
                    // Default topics if none exist
                    "Main Topic", "Key Concept", "Study Material", "Important Point"
                {% endif %}
            ];
            
            // ========== Create Nodes Array ==========
            // Each topic becomes a node in the graph
            graphData = {
                nodes: fallbackTopics.map((topic, i) => ({
                    id: `node_${i}`,                    // Unique identifier
                    label: topic.substring(0, 25),      // Display text (max 25 chars)
                    type: i < 3 ? 'main' : 'sub',       // First 3 are main topics
                    color: i < 3 ? '#4CAF50' : '#2196F3', // Green for main, blue for sub
                    size: i < 3 ? 25 : 18               // Larger size for main topics
                })),
                edges: []  // Will be populated below
            };
            
            // ========== Create Hub Connections ==========
            // Connect first node (main topic) to other nodes
            for (let i = 1; i < Math.min(fallbackTopics.length, 6); i++) {
                graphData.edges.push({
                    source: 'node_0',       // From main topic
                    target: `node_${i}`,    // To sub-topic
                    weight: 2               // Connection strength
                });
            }
            
            // ========== Create Sequential Connections ==========
            // Connect nodes in sequence (forms a chain)
            for (let i = 0; i < fallbackTopics.length - 1; i++) {
                if (i < 4) {  // Limit to prevent too many connections
                    graphData.edges.push({
                        source: `node_${i}`,
                        target: `node_${i + 1}`,
                        weight: 1
                    });
                }
            }
        }
        
        console.log(`Final graph: ${graphData.nodes.length} nodes, ${graphData.edges.length} edges`);
        
        // ========== Remove Loading Message ==========
        // Graph data is ready, hide the loading text
        document.getElementById('loading-message').remove();
        
        // ========== Set Graph Dimensions ==========
        const width = 800;   // SVG width in pixels
        const height = 600;  // SVG height in pixels
        
        // ========== Create SVG Container ==========
        // Create the main SVG element where the graph will be drawn
        const svg = d3.select("#graph-container")
            .append("svg")
            .attr("width", "100%")                  // Responsive width
            .attr("height", height)                 // Fixed height
            .attr("viewBox", `0 0 ${width} ${height}`)  // Scalable viewport
            .style("background", "white")           // White background
            .style("border", "1px solid #ddd")      // Light border
            .style("border-radius", "8px");         // Rounded corners
        
        // ========== Create Force Simulation ==========
        // D3 force simulation positions nodes based on physics
        const simulation = d3.forceSimulation(graphData.nodes)
            // Link force: Pulls connected nodes together
            .force("link", d3.forceLink(graphData.edges).id(d => d.id).distance(120))
            // Charge force: Pushes all nodes apart (like magnets)
            .force("charge", d3.forceManyBody().strength(-400))
            // Center force: Pulls all nodes toward the center
            .force("center", d3.forceCenter(width / 2, height / 2))
            // Collision force: Prevents nodes from overlapping
            .force("collision", d3.forceCollide().radius(40));
        
        // ========== Draw Links (Edges) ==========
        // Create lines connecting related nodes
        const link = svg.append("g")
            .selectAll("line")
            .data(graphData.edges)
            .enter().append("line")
            .attr("stroke", "#999")                 // Gray color
            .attr("stroke-opacity", 0.6)            // Semi-transparent
            .attr("stroke-width", d => Math.sqrt(d.weight || 1) * 2);  // Thicker for stronger connections
        
        // ========== Create Node Groups ==========
        // Each node is a group (g) containing circle + text
        const node = svg.append("g")
            .selectAll("g")
            .data(graphData.nodes)
            .enter().append("g")
            // Enable drag-and-drop functionality
            .call(d3.drag()
                .on("start", dragstarted)   // When drag starts
                .on("drag", dragged)        // While dragging
                .on("end", dragended));     // When drag ends
        
        // ========== Add Circles to Nodes ==========
        // Each node displays as a colored circle
        node.append("circle")
            .attr("r", d => d.size || 20)           // Radius based on node size
            .attr("fill", d => d.color || '#4CAF50') // Node color
            .attr("stroke", "#fff")                 // White border
            .attr("stroke-width", 3)                // Border thickness
            .style("cursor", "grab");               // Hand cursor on hover
        
        // ========== Add Labels to Nodes ==========
        // Text label next to each circle showing topic name
        node.append("text")
            .text(d => d.label)                     // Topic text
            .attr("font-size", 12)                  // Text size
            .attr("font-weight", "bold")            // Bold text
            .attr("dx", 35)                         // Horizontal offset from circle
            .attr("dy", 5)                          // Vertical alignment
            .style("pointer-events", "none")        // Text doesn't block mouse events
            .style("font-family", "Arial, sans-serif");
        
        // ========== Add Tooltips ==========
        // Shows full topic name on hover
        node.append("title")
            .text(d => d.label);
        
        // ========== Update Positions on Each Simulation Tick ==========
        // Called repeatedly as the simulation runs
        simulation.on("tick", () => {
            // Update link positions (connect node centers)
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
            
            // Update node positions (move circle + text together)
            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });
        
        // ========== Drag Event Handlers ==========
        
        /**
         * When drag starts: heat up simulation and fix node position
         */
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;  // Fix x position
            d.fy = d.y;  // Fix y position
            d3.select(this).select("circle").style("cursor", "grabbing");  // Change cursor
        }
        
        /**
         * While dragging: update fixed position to follow mouse
         */
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        /**
         * When drag ends: unfix node so simulation can move it again
         */
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;  // Unfix x position
            d.fy = null;  // Unfix y position
            d3.select(this).select("circle").style("cursor", "grab");  // Reset cursor
        }
        
        console.log(' Concept map visualization complete!');
    </script>
</div>

<!-- ========== Inline CSS Styles ========== -->
<!-- Custom styling specific to the concept map page -->
<style>
    /* ========== Main Container ========== */
    /* Center the concept map and limit width */
    .concept-map-container {
        max-width: 1400px;     /* Don't get too wide on large screens */
        margin: 0 auto;        /* Center horizontally */
    }
    
    /* ========== Header Section Styles ========== */
    /* Style the page header with title and subtitle */
    .concept-map-header {
        text-align: center;    /* Center all text */
        margin-bottom: 2rem;   /* Space below header */
    }
    
    /* Style the main heading with icon */
    .concept-map-header h1 {
        display: flex;              /* Use flexbox for layout */
        align-items: center;        /* Center items vertically */
        justify-content: center;    /* Center items horizontally */
        gap: 1rem;                 /* Space between icon and text */
        margin-bottom: 0.5rem;     /* Small space below heading */
    }
    
    /* ========== Visualization Layout ========== */
    /* Two-column grid: graph on left, topics on right */
    .concept-visualization {
        display: grid;                      /* Use CSS Grid */
        grid-template-columns: 1fr 300px;   /* Main area + sidebar */
        gap: 2rem;                         /* Space between columns */
        margin-top: 2rem;                  /* Space above section */
    }
    
    /* ========== Graph Container Styles ========== */
    /* Container for the D3.js SVG graph */
    #graph-container {
        background: white;                          /* White background */
        border-radius: 8px;                         /* Rounded corners */
        padding: 1rem;                              /* Internal spacing */
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);    /* Drop shadow */
        min-height: 600px;                          /* Minimum height */
        display: flex;                              /* Flexbox for centering */
        align-items: center;                        /* Center vertically */
        justify-content: center;                    /* Center horizontally */
    }
    
    /* ========== Loading Message Styles ========== */
    /* Shown while graph is being created */
    #loading-message {
        color: #666;               /* Gray text */
        font-size: 1.2rem;        /* Larger text */
        font-weight: bold;        /* Bold text */
    }
    
    /* ========== Topics List Sidebar ========== */
    /* Container for the topics list on the right */
    .topics-list {
        background: white;                          /* White background */
        border-radius: 8px;                         /* Rounded corners */
        padding: 2rem;                              /* Internal spacing */
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);    /* Drop shadow */
        height: fit-content;                        /* Height based on content */
        max-height: 600px;                          /* Maximum height */
        overflow-y: auto;                           /* Scroll if too many topics */
    }
    
    /* Topics list heading */
    .topics-list h3 {
        color: var(--primary-color);   /* Use theme primary color */
        margin-bottom: 1rem;           /* Space below heading */
        font-size: 1.3rem;            /* Larger font */
    }
    
    /* Remove default list styling */
    .topics-list ul {
        list-style: none;              /* No bullets */
        padding: 0;                    /* No padding */
    }
    
    /* ========== Individual Topic Items ========== */
    /* Style for each topic in the list */
    .topics-list li {
        padding: 0.75rem;                      /* Internal spacing */
        color: #666;                           /* Gray text */
        border-bottom: 1px solid #f0f0f0;      /* Bottom border separator */
        transition: background 0.3s;           /* Smooth hover effect */
    }
    
    /* Hover effect for topic items */
    .topics-list li:hover {
        background: #f9f9f9;           /* Light gray background on hover */
    }
    
    /* Icon styling in topic list */
    .topics-list i {
        color: var(--primary-color);   /* Primary color for icons */
        margin-right: 0.75rem;         /* Space after icon */
    }
    
    /* ========== Responsive Design ========== */
    /* Mobile and tablet layout adjustments */
    @media (max-width: 768px) {
        /* Stack columns vertically on small screens */
        .concept-visualization {
            grid-template-columns: 1fr;    /* Single column */
        }
        
        /* Make graph scrollable horizontally on mobile */
        #graph-container {
            width: 100%;               /* Full width */
            overflow-x: auto;          /* Horizontal scroll */
        }
    }
</style>
{% endblock %}